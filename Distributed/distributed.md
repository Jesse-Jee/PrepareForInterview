# 一致性算法
- 主从同步
    - master接收写请求
    - master复制日志到slave
    - master等待，直到所有slave返回。

缺点： 一个slave挂了，master阻塞，集群不可用。保证了一致性，可用性降低。      

## 什么是分布式共识
一个客户端向单独一个节点发送数据，两者很容易就数据达成共识。
当我们有多个节点的时候呢？                  

## raft
强一致性算法，用于分布式共识的协议工具
主要完成三件事：
- leader选举
- 日志复制
- 保证分布式共识


一个节点可能有三种状态：leader， follower， candidate         

**leader选举**
- 所有节点一开始都是follower状态。
- 如果follower没有收到leader的信息，就可以变成候选人。
- 候选人请求其他节点给自己投票
- 如果获得超过半数投票，那么候选人变成leader。


**raftleader选举复杂情况**

- raft中有两个超时设置可以控制选举
- 当选举超时（follower成为candidate之前要等待的时候）时，选举超时的时间随机分配在150Ms到300Ms之间。
- 首先超过超时时间的follower成为候选人，先把自己的vote count +1，自己投自己，同时让大家投票。见上。
- 如果在接收到请求的时候，node还没投过票，那么就把票投给这个候选人，并且重置超时时间。
- 一旦选举人获得超过半数投票，就成为leader。
- leader向follower发送添加条目信息
- 这些消息以心跳超时的时间间隔发送
- follower响应添加条目请求，接收到请求同时重置超时时间。直到接收不到leader心跳为止。


一种异常情况：
- 如果两个node同时成为了候选人，那么会发生拆分表决。
- 两个节点相同时间开始进行选举，每个都先到达一个节点。然后每人都得了相同票数。
- 节点就会等待一个超时周期，重新发起选举。      
- 获得超半数的node投票成为leader



系统所有改变都要经过leader。

**日志复制**      

- 客户端给leader节点发送信息
- 每个信息都会添加为节点的log条目
- log条目没有提交就不会更新node的值
- leader将条目保存，并在下个心跳周期将条目发送到follower节点
- leader等待大多数节点都写入了该条目的反馈
- leader中值修改成功，返回给客户端response。然后通知follower已提交。
- 集群达成共识。

在面临网络分区时，raft仍然能保持一致。
- 可能会造成有两个leader的局面。
- 当客户端发送信息给其中一个leader时，因为不能发送到绝大多数node上，所以信息保持未提交。
- 另一个客户端发送消息给另一个leader试图修改某个信息时，可能会成功，因为可能这个leader掌握大多数node。

当分区结束，网络恢复了，两个leader如何处理呢？
- 掌握少数node的leader看到一个大佬leader更高的选举期然后退出。
- 这些少数派将回滚未提交的条目并匹配新领导的log。
- 集群恢复如初。


        
    
# 分布式事务


#